<div class="flex-1 mx-40 p-4">
  <%= link_to "戻る", posts_path, class: "btn btn-xs btn-outline" %>

  <div class="overflow-hidden">

    <!-- 動画表示 -->
    <% if @post.video_url.present? %>
      <% youtube_id = @post.video_url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/)&.captures&.first %>
        <% if youtube_id %>
          <div class="relative w-full shadow-md" style="padding-bottom: 56.25%;">
            <iframe
              src="https://www.youtube.com/embed/<%= youtube_id %>"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
              class="absolute top-0 left-0 w-full h-full rounded-lg"></iframe>
          </div>
        <% else %>
          <div class="bg-gray-200 flex items-center justify-center h-64 rounded-md">
            <span class="text-gray-500">Invalid YouTube URL</span>
          </div>
        <% end %>
    <% end %>

    <!-- いいねボタン -->
    <div class="rounded-full border w-auto flex justify-center">
      <div class="mx-2">
        <%= render "like_btn", post: @post, variant: :medium %>
      </div>
      <div class="border"></div>
      <div class="mx-2">
        <%= render "favorite_btn", post: @post, variant: :medium %>
      </div>
    </div>

    <div class="p-4 flex flex-row justify-between">
      <div class="flex items-center flex-row">
        <div class="flex-shrink-0 mr-2">
          <% if @post.user.respond_to?(:avatar) && @post.user.avatar.attached? %>
            <%= image_tag url_for(@post.user.avatar), class: "w-12 h-12 rounded-full object-cover", alt: @post.user.user_name %>
          <% else %>
            <div class="w-12 h-12 bg-primary text-primary-content rounded-full flex items-center justify-center">
              <span class="text-sm font-bold"><%= @post.user.user_name[0].upcase %></span>
            </div>
          <% end %>
        </div>

        <div class="flex flex-col">
          <h1 class="text-2xl font-bold"><%= @post.title %></h1>
          <div class="flex items-center">
            <div class="text-sm text-gray-500">
              <span>おすすめ者: <%= @post.user.user_name %></span>
              <span class="mx-1">•</span>
              <span><%= @post.created_at.strftime("%y/%m/%d") %></span>
            </div>
          </div>
        </div>
      </div>

      <div class="flex gap-2">
        <% if current_user && current_user.id == @post.user_id %>
          <%= link_to edit_post_path(@post),
              class: "btn rounded-md bg-base-300 hover:bg-base-200 shadow-md" do %>
            <i class="fas fa-edit text-xl"></i>
          <% end %>

          <%= button_to post_path(@post),
              method: :delete,
              form: { data: { turbo_confirm: "この投稿を削除してもよろしいですか？" } },
              class: "btn rounded-md bg-base-300 hover:bg-base-200 shadow-md" do %>
            <i class="fas fa-trash-alt text-xl"></i>
          <% end %>
        <% end %>
      </div>
    </div>

    <div class="p-4">
      <div class="p-2 bg-base-300 shadow-md rounded-lg">
        <h2 class="text-lg font-semibold mb-2">使用キャラクター</h2>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
          <% @post.posts_to_characters.includes(:character).each do |ptc| %>
            <div class="relative flex flex-col items-center">
              <div class="relative flex justify-center">
                <% if ptc.character.respond_to?(:character_img) && ptc.character.character_img.attached? %>
                  <%= image_tag url_for(ptc.character.character_img), class: "h-24 object-contain" %>
                <% end %>

                <div class="absolute bottom-0 right-1 bg-black bg-opacity-60 text-white rounded-full p-1 text-xs">
                  <%= ptc.constellation || 0 %>凸
                </div>
              </div>

              <div class="text-center">
                <div class="text-md"><%= ptc.character.name %></div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="p-4">
      <h2 class="text-xl font-semibold mb-2">おすすめポイント</h2>
      <div class="text-lg">
        <%= simple_format(@post.body) %>
      </div>
    </div>

    <!-- コメント機能 -->
    <div class="p-4">
      <div>
        <%= render 'comments/form', comment: @comment, post: @post %>
      </div>
      <div id="table-comment">
        <% @comments.where(parent_id: nil).each do |comment| %>
          <%= render 'comments/comment', comment: comment %>
        <% end %>
      </div>
    </div>

  </div>
</div>
